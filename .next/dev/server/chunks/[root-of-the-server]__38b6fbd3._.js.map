{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jayesh_naphade/.gemini/antigravity/scratch/ai_tutor_demo/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport path from 'path';\r\n// Explicitly set absolute path to service account key to avoid ENOENT\r\nprocess.env.GOOGLE_APPLICATION_CREDENTIALS = path.join(__dirname, '../../service-account-key.json');\r\n\r\nexport interface ChatMessage {\r\n    role: \"user\" | \"model\";\r\n    parts: string;\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const { history, message, transcript } = await req.json();\r\n\r\n        const apiKey = process.env.NEXT_PUBLIC_GEMINI_API_KEY;\r\n        console.log(\"API Key check:\", apiKey ? \"Found\" : \"Missing\");\r\n\r\n        if (!apiKey) {\r\n            console.error(\"API Key missing from environment\");\r\n            return NextResponse.json({ error: 'Gemini API Key is missing from environment' }, { status: 500 });\r\n        }\r\n\r\n        const genAI = new GoogleGenerativeAI(apiKey);\r\n        const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n        const systemPrompt = `You are an AI Tutor. You are helpful, friendly, and concise.\r\nYou have been provided with the following video transcript:\r\n\"${transcript}\"\r\n\r\nCRITICAL INSTRUCTIONS:\r\n1. Answer the user's questions based ONLY on the content of the transcript above.\r\n2. If the answer is not in the transcript, politely say: \"I'm sorry, but that information isn't covered in this video.\"\r\n3. Do not use outside knowledge.\r\n4. Keep your responses conversational and suitable for a voice interface (avoid long lists or complex formatting unless necessary).\r\n5. Your response will be spoken out loud, so use natural language.`;\r\n\r\n        const chat = model.startChat({\r\n            history: [\r\n                {\r\n                    role: \"user\",\r\n                    parts: [{ text: systemPrompt }],\r\n                },\r\n                {\r\n                    role: \"model\",\r\n                    parts: [{ text: \"Understood. I am ready to answer questions based strictly on the video transcript provided.\" }],\r\n                },\r\n                ...history.map((msg: ChatMessage) => ({\r\n                    role: msg.role,\r\n                    parts: [{ text: msg.parts }],\r\n                })),\r\n            ],\r\n        });\r\n\r\n        const result = await chat.sendMessage(message);\r\n        const response = result.response;\r\n        const text = response.text();\r\n\r\n        return NextResponse.json({ response: text });\r\n\r\n    } catch (error: any) {\r\n        console.error('=== CHAT API ERROR ===');\r\n        console.error('Error Type:', error.constructor?.name);\r\n        console.error('Error Message:', error.message);\r\n        console.error('Error Status:', error.status || error.statusText);\r\n        console.error('Full Error:', error);\r\n        console.error('======================');\r\n\r\n        return NextResponse.json({\r\n            error: 'Internal Server Error',\r\n            details: error.message || String(error),\r\n            errorType: error.constructor?.name,\r\n            status: error.status || error.statusText\r\n        }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AACA,sEAAsE;AACtE,QAAQ,GAAG,CAAC,8BAA8B,GAAG,4GAAI,CAAC,IAAI,mGAAY;AAO3D,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,UAAU,EAAE,GAAG,MAAM,IAAI,IAAI;QAEvD,MAAM;QACN,QAAQ,GAAG,CAAC,kBAAkB,uCAAS,UAAU;QAEjD;;QAKA,MAAM,QAAQ,IAAI,6OAAkB,CAAC;QACrC,MAAM,QAAQ,MAAM,kBAAkB,CAAC;YAAE,OAAO;QAAmB;QAEnE,MAAM,eAAe,CAAC;;CAE7B,EAAE,WAAW;;;;;;;kEAOoD,CAAC;QAE3D,MAAM,OAAO,MAAM,SAAS,CAAC;YACzB,SAAS;gBACL;oBACI,MAAM;oBACN,OAAO;wBAAC;4BAAE,MAAM;wBAAa;qBAAE;gBACnC;gBACA;oBACI,MAAM;oBACN,OAAO;wBAAC;4BAAE,MAAM;wBAA8F;qBAAE;gBACpH;mBACG,QAAQ,GAAG,CAAC,CAAC,MAAqB,CAAC;wBAClC,MAAM,IAAI,IAAI;wBACd,OAAO;4BAAC;gCAAE,MAAM,IAAI,KAAK;4BAAC;yBAAE;oBAChC,CAAC;aACJ;QACL;QAEA,MAAM,SAAS,MAAM,KAAK,WAAW,CAAC;QACtC,MAAM,WAAW,OAAO,QAAQ;QAChC,MAAM,OAAO,SAAS,IAAI;QAE1B,OAAO,uMAAY,CAAC,IAAI,CAAC;YAAE,UAAU;QAAK;IAE9C,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC;QACd,QAAQ,KAAK,CAAC,eAAe,MAAM,WAAW,EAAE;QAChD,QAAQ,KAAK,CAAC,kBAAkB,MAAM,OAAO;QAC7C,QAAQ,KAAK,CAAC,iBAAiB,MAAM,MAAM,IAAI,MAAM,UAAU;QAC/D,QAAQ,KAAK,CAAC,eAAe;QAC7B,QAAQ,KAAK,CAAC;QAEd,OAAO,uMAAY,CAAC,IAAI,CAAC;YACrB,OAAO;YACP,SAAS,MAAM,OAAO,IAAI,OAAO;YACjC,WAAW,MAAM,WAAW,EAAE;YAC9B,QAAQ,MAAM,MAAM,IAAI,MAAM,UAAU;QAC5C,GAAG;YAAE,QAAQ;QAAI;IACrB;AACJ"}}]
}