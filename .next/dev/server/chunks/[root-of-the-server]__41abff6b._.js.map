{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jayesh_naphade/.gemini/antigravity/scratch/ai_tutor_demo/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport path from 'path';\r\n\r\n// Explicitly set absolute path to service account key to avoid ENOENT\r\nprocess.env.GOOGLE_APPLICATION_CREDENTIALS = \"C:\\\\Users\\\\jayesh_naphade\\\\.gemini\\\\antigravity\\\\scratch\\\\ai_tutor_demo\\\\service-account-key.json\";\r\n\r\nexport interface ChatMessage {\r\n    role: \"user\" | \"model\";\r\n    parts: string;\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const startTime = Date.now();\r\n        const { history, message, transcript } = await req.json();\r\n\r\n        console.log(\"=== CHAT API REQUEST ===\");\r\n        console.log(\"Message:\", message);\r\n        console.log(\"Transcript received:\", transcript ? `YES (${transcript.length} chars)` : \"NO\");\r\n\r\n        // Validate transcript is actually present and not empty\r\n        const hasValidTranscript = transcript && transcript.trim().length > 0;\r\n        if (hasValidTranscript) {\r\n            console.log(\"Transcript preview:\", transcript.substring(0, 200) + \"...\");\r\n        }\r\n\r\n        const apiKey = process.env.NEXT_PUBLIC_GEMINI_API_KEY;\r\n\r\n        if (!apiKey) {\r\n            console.error(\"API Key missing from environment\");\r\n            return NextResponse.json({ error: 'Gemini API Key is missing from environment' }, { status: 500 });\r\n        }\r\n\r\n        const genAI = new GoogleGenerativeAI(apiKey);\r\n        const modelName = process.env.GEMINI_MODEL || \"gemini-2.0-flash\";\r\n        console.log(`Using Gemini Model: ${modelName}`);\r\n        const model = genAI.getGenerativeModel({\r\n            model: modelName,\r\n            generationConfig: {\r\n                temperature: 0.7,\r\n                maxOutputTokens: 60,\r\n            }\r\n        });\r\n\r\n        let systemPrompt = \"\";\r\n\r\n        if (hasValidTranscript) {\r\n            systemPrompt = `You are an AI Tutor helping a student understand a video.\r\n\r\nCONTEXT (VIDEO TRANSCRIPT):\r\n\"\"\"\r\n${transcript}\r\n\"\"\"\r\n\r\nCRITICAL INSTRUCTIONS:\r\n1. **PRIMARY SOURCE:** Answer ONLY using information from the VIDEO TRANSCRIPT above. Do NOT use any outside knowledge.\r\n2. **STRICT BOUNDARY:** If the answer is not in the transcript, say \"I cannot find that information in the video.\"\r\n3. **CONCISENESS:** Keep responses to 1-2 sentences maximum.\r\n4. **STYLE:** Be friendly and conversational, but strictly factual based on the video.\r\n5. **FORMAT:** Plain text only, no markdown.`;\r\n        } else {\r\n            systemPrompt = `You are an AI Video Tutor.\r\n\r\nThe video transcript is unavailable. Answer general questions about the topic.\r\n\r\nRULES:\r\n1. Answer should be short and concise.\r\n2. No markdown formatting\r\n3. Be helpful`;\r\n        }\r\n\r\n        // Validate and sanitize history\r\n        const validHistory = Array.isArray(history) ? history.filter((msg: any) => msg && msg.role && msg.parts) : [];\r\n\r\n        const chat = model.startChat({\r\n            history: [\r\n                {\r\n                    role: \"user\",\r\n                    parts: [{ text: systemPrompt }],\r\n                },\r\n                {\r\n                    role: \"model\",\r\n                    parts: [{ text: \"Understood. I am ready to answer questions.\" }],\r\n                },\r\n                ...validHistory.map((msg: ChatMessage) => ({\r\n                    role: msg.role,\r\n                    parts: [{ text: String(msg.parts || \"\") }],\r\n                })),\r\n            ],\r\n        });\r\n\r\n        const modelStartTime = Date.now();\r\n        const result = await chat.sendMessage(message);\r\n        const response = result.response;\r\n        const text = response.text();\r\n        const modelEndTime = Date.now();\r\n\r\n        console.log(`Model response time: ${modelEndTime - modelStartTime}ms`);\r\n        console.log(`Total request time: ${modelEndTime - startTime}ms`);\r\n        console.log(\"Response:\", text);\r\n\r\n        return NextResponse.json({ response: text });\r\n\r\n    } catch (error: any) {\r\n        console.error('=== CHAT API ERROR ===');\r\n        console.error('Error Type:', error.constructor?.name);\r\n        console.error('Error Message:', error.message);\r\n        console.error('Full Error:', error);\r\n\r\n        return NextResponse.json({\r\n            error: 'Internal Server Error',\r\n            details: error.message || String(error)\r\n        }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAGA,sEAAsE;AACtE,QAAQ,GAAG,CAAC,8BAA8B,GAAG;AAOtC,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,YAAY,KAAK,GAAG;QAC1B,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,UAAU,EAAE,GAAG,MAAM,IAAI,IAAI;QAEvD,QAAQ,GAAG,CAAC;QACZ,QAAQ,GAAG,CAAC,YAAY;QACxB,QAAQ,GAAG,CAAC,wBAAwB,aAAa,CAAC,KAAK,EAAE,WAAW,MAAM,CAAC,OAAO,CAAC,GAAG;QAEtF,wDAAwD;QACxD,MAAM,qBAAqB,cAAc,WAAW,IAAI,GAAG,MAAM,GAAG;QACpE,IAAI,oBAAoB;YACpB,QAAQ,GAAG,CAAC,uBAAuB,WAAW,SAAS,CAAC,GAAG,OAAO;QACtE;QAEA,MAAM;QAEN;;QAKA,MAAM,QAAQ,IAAI,6OAAkB,CAAC;QACrC,MAAM,YAAY,QAAQ,GAAG,CAAC,YAAY,IAAI;QAC9C,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,WAAW;QAC9C,MAAM,QAAQ,MAAM,kBAAkB,CAAC;YACnC,OAAO;YACP,kBAAkB;gBACd,aAAa;gBACb,iBAAiB;YACrB;QACJ;QAEA,IAAI,eAAe;QAEnB,IAAI,oBAAoB;YACpB,eAAe,CAAC;;;;AAI5B,EAAE,WAAW;;;;;;;;4CAQ+B,CAAC;QACrC,OAAO;YACH,eAAe,CAAC;;;;;;;aAOf,CAAC;QACN;QAEA,gCAAgC;QAChC,MAAM,eAAe,MAAM,OAAO,CAAC,WAAW,QAAQ,MAAM,CAAC,CAAC,MAAa,OAAO,IAAI,IAAI,IAAI,IAAI,KAAK,IAAI,EAAE;QAE7G,MAAM,OAAO,MAAM,SAAS,CAAC;YACzB,SAAS;gBACL;oBACI,MAAM;oBACN,OAAO;wBAAC;4BAAE,MAAM;wBAAa;qBAAE;gBACnC;gBACA;oBACI,MAAM;oBACN,OAAO;wBAAC;4BAAE,MAAM;wBAA8C;qBAAE;gBACpE;mBACG,aAAa,GAAG,CAAC,CAAC,MAAqB,CAAC;wBACvC,MAAM,IAAI,IAAI;wBACd,OAAO;4BAAC;gCAAE,MAAM,OAAO,IAAI,KAAK,IAAI;4BAAI;yBAAE;oBAC9C,CAAC;aACJ;QACL;QAEA,MAAM,iBAAiB,KAAK,GAAG;QAC/B,MAAM,SAAS,MAAM,KAAK,WAAW,CAAC;QACtC,MAAM,WAAW,OAAO,QAAQ;QAChC,MAAM,OAAO,SAAS,IAAI;QAC1B,MAAM,eAAe,KAAK,GAAG;QAE7B,QAAQ,GAAG,CAAC,CAAC,qBAAqB,EAAE,eAAe,eAAe,EAAE,CAAC;QACrE,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,eAAe,UAAU,EAAE,CAAC;QAC/D,QAAQ,GAAG,CAAC,aAAa;QAEzB,OAAO,uMAAY,CAAC,IAAI,CAAC;YAAE,UAAU;QAAK;IAE9C,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC;QACd,QAAQ,KAAK,CAAC,eAAe,MAAM,WAAW,EAAE;QAChD,QAAQ,KAAK,CAAC,kBAAkB,MAAM,OAAO;QAC7C,QAAQ,KAAK,CAAC,eAAe;QAE7B,OAAO,uMAAY,CAAC,IAAI,CAAC;YACrB,OAAO;YACP,SAAS,MAAM,OAAO,IAAI,OAAO;QACrC,GAAG;YAAE,QAAQ;QAAI;IACrB;AACJ"}}]
}